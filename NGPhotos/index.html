<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="description" content="Conheça o projeto NovaGenesis, uma arquitetura alternativa de Internet redesenhada do zero." />
    <meta property="og:description" content="Conheça o projeto NovaGenesis, uma arquitetura alternativa de Internet redesenhada do zero." />
    <meta property="og:title" content="NovaGenesis - Inatel" />
    <meta property="og:site_name" content="NovaGenesis" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@inateloficial" />
    <meta name="twitter:title" content="NovaGenesis - Inatel" />
    <meta name="twitter:description" content="Conheça o projeto NovaGenesis, uma arquitetura alternativa de Internet redesenhada do zero." />
    <meta name="author" content="Inatel" />
    <meta property="og:image" content="https://inatel.br/novagenesis-futuro/images/seo-home.jpg" />
    <meta property="og:image:secure_url" content="https://inatel.br/novagenesis-futuro/images/seo-home.jpg" />
    <meta property="og:image:alt" content="Conheça o projeto NovaGenesis, uma arquitetura alternativa de Internet redesenhada do zero." />
    <meta property="og:image:type" content="image/jpeg" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:locale" content="pt_BR" />
    <meta name="twitter:image" content="https://inatel.br/novagenesis-futuro/images/seo-home.jpg" />
    <meta name="twitter:image:alt" content="Conheça o projeto NovaGenesis, uma arquitetura alternativa de Internet redesenhada do zero." />
    <meta name="robots" content="index, follow" />
    <meta property="og:url" content="https://inatel.br/novagenesis-futuro/" />
    <link rel="canonical" href="https://inatel.br/novagenesis-futuro/" />
    <link href="https://inatel.br/novagenesis-futuro/images/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon">
    <title>NovaGenesis | Inatel</title>

    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div>
        <!-- Intial text message with a button to listen to an audio -->
        <div id="initialInfo">
            <picture class="face">
                <source type="image/webp" srcset="images/face.webp" media="(min-width: 1367px)" width="860" height="491">
                <source type="image/webp" srcset="images/face-560.webp" media="(min-width: 367px)" width="560" height="319">
                <source type="image/webp" srcset="images/face-320.webp" media="(min-width: 1px)" width="320" height="182">
                
                <source type="image/png" srcset="images/face.webp" media="(min-width: 1367px)" width="860" height="491">
                <source type="image/png" srcset="images/face-560.webp" media="(min-width: 367px)" width="560" height="319">    
                <source type="image/png" srcset="images/face-320.webp" media="(min-width: 1px)" width="320" height="182">
                
                <img src="images/face.png" alt="face" draggable="false">
            </picture>
            <div class="init-up">
                <span class="ocr">ENTROU NA CÁPSULA?</span>
                <span class="ocr">PRÓXIMA PARADA: INTERNET DO FUTURO!</span>
            </div>
            <h1>
                <picture>
                    <source type="image/webp" srcset="images/novagenesis.webp" media="(min-width: 1367px)" width="860" height="491">
                    <source type="image/webp" srcset="images/novagenesis-560.webp" media="(min-width: 367px)" width="560"
                        height="319">
                    <source type="image/webp" srcset="images/novagenesis-320.webp" media="(min-width: 1px)" width="320"
                        height="182">
            
                    <source type="image/png" srcset="images/novagenesis.webp" media="(min-width: 1367px)" width="860" height="491">
                    <source type="image/png" srcset="images/novagenesis-560.webp" media="(min-width: 367px)" width="560"
                        height="319">
                    <source type="image/png" srcset="images/novagenesis-320.webp" media="(min-width: 1px)" width="320" height="182">
            
            
                    <source type="image/webp" srcset="images/novagenesis.webp">
                    <img src="images/novagenesis.png" alt="Novagenesis" draggable="false">
                </picture>
            </h1>
            <p class="init-down">
                O PROJETO NOVAGENESIS IRÁ REVOLUCIONAR
                <strong>O CAMPO TECNOLÓGICO REDESENHANDO UM</strong>
                MODELO ALTERNATIVO DE INTERNET DO ZERO
            </p>

            <button id="audioButton" type="button" onclick="playAudio()" class="audio">OUÇA O FUTURO</button>
        </div>
        <!-- Form to capture the name and email -->
        <div id="formBox">
            <form action="">
                <div class="input">
                    <label for="name">Coloque seu nome</label>
                    <input type="text" name="name" id="name" tabindex="0" value="">
                </div>
        
                <div class="input">
                    <label for="email">Coloque seu melhor email</label>
                    <input type="email" name="email" id="email" tabindex="0" value="">
                </div>
        
                <p class="mb60">Ao enviar, você aceita a <a href="https://inatel.br/politica-privacidade" target="_blank"
                        tabindex="0">Política de Privacidade</a> do Inatel</p>
        
                <p class="ocr">Bora fazer parte disso?</p>
                <p class="ocr">Prepare teu melhor sorriso e aperte COMEÇAR.</p>
                <p class="ocr">A cada 2 segundos a câmera tirará uma nova foto sua!</p>
        
                <button type="button" id="capturarButton" onclick="startCapture()" class="audio" disabled>Começar</button>
            </form>
        </div>

        <!-- Last meessage -->
        <div id="lastMessage" class="congratulation">
            <h2>AGRADECEMOS A SUA PARTICIPAÇÃO!</h2>
        
            <p>Saia da Cápsula, procure sua foto no telão da NovaGenesis e conte para todos.</p>
        
            <p><strong>Bom evento</strong></p>
        </div>
    </div>
    <div id="cameraPreview">
        <!-- Camera preview -->
        <div id="videoCamera"></div>
        <!-- Filter over the camera preview -->
        <div id="filterPreview"></div>
    </div>
    <div id="timer-container">
        <div id="timer">0</div>
    </div>

    <script>
        // Function to play the audio
        function playAudio() {
            // Disable the button
            disableAudioButton();
            // Disabe form button
            disableFormButton();
            // open audio from local file audioTest.mp3
            const audio = new Audio('audioFetin.mp3');
            audio.play();
            // Wait audio to finish and then show the form
            audio.onended = function () {
                // Show the form
                document.getElementById('formBox').style.display = 'block';
                // Hide the initial info
                document.getElementById('initialInfo').style.display = 'none';
            };
        }

        function disableAudioButton() {
            const audioButton = document.getElementById('audioButton');
            audioButton.disabled = true;
            audioButton.style.cursor = 'not-allowed';
        }

        function disableFormButton() {
            const formButton = document.getElementById('capturarButton');
            formButton.disabled = true;
            formButton.style.cursor = 'not-allowed';
        }

        function enableAudioButton() {
            const audioButton = document.getElementById('audioButton');
            audioButton.disabled = false;
            audioButton.style.cursor = 'pointer';
        }

        function enableFormButton() {
            const formButton = document.getElementById('capturarButton');
            formButton.disabled = false;
            formButton.style.cursor = 'pointer';
        }

        // Function to start capturing the webcam image
        function startCapture() {
            startPhotoCaptureTimer();
        }

        function startPhotoCaptureTimer() {
            var photosToCapture = 3;
            var capturedPhotos = 0;
            var photosProcessed = false;
            var count = 0;
            var intervalBetweenPhotos = 3;
            var timer = document.getElementById('timer');
            var timerContainer = document.getElementById('timer-container');
            timerContainer.style.display = 'block';

            // Hide the form
            document.getElementById('formBox').style.display = 'none';

            document.getElementById('cameraPreview').style.display = 'flex';
            document.getElementById('videoCamera').style.display = 'block';
            document.getElementById('filterPreview').style.display = 'block';
            
            var intervalId;
            var fileNames = [];
            const nameInput = document.getElementById('name');
            const emailInput = document.getElementById('email');
            const data = {
                name: nameInput.value,
                email: emailInput.value
            };
            async function updateTimer() {
                if (capturedPhotos == photosToCapture && !photosProcessed) {
                    photosProcessed = true;
                    console.log('photos will be processed');
                    // Close the webcam preview
                    document.getElementById('cameraPreview').style.display = 'none';
                    document.getElementById('videoCamera').style.display = 'none';
                    document.getElementById('filterPreview').style.display = 'none';
                    document.getElementById('timer-container').style.display = 'none';

                    // Show last message for 10 seconds
                    document.getElementById('lastMessage').style.display = 'flex';
                    // Process images
                    const imageProccessing = await processImages(fileNames);
                    console.log('images processed');

                    // Send email
                    setTimeout(function () {
                        console.log('sending email');
                        sendEmail(data, fileNames);
                    }, 1000);
                    
                    reset();
                }
                if (count == intervalBetweenPhotos && capturedPhotos < photosToCapture && data.name && data.email) {
                    capturedPhotos += 1;
                    blinkScreen();
                    fileNames.push(capturePhoto());
                }
                count = count == (intervalBetweenPhotos || capturedPhotos == photosToCapture) ? count = 0 : count + 1;
                timer.innerText = count;
            }

            function blinkScreen() {
                var body = document.getElementsByTagName('body')[0];
                body.classList.add('blinking');
                setTimeout(function () {
                    body.classList.remove('blinking');
                }, 700);
            }

            function reset() {
                clearInterval(intervalId);
                document.getElementById('name').value = '';
                document.getElementById('email').value = '';
                checkFormValidity()
                timerContainer.style.display = 'none';
                setTimeout(function () {
                    document.getElementById('lastMessage').style.display = 'none';
                    document.getElementById('initialInfo').style.display = 'block';
                    enableAudioButton();
                }, 20000);

            }

            intervalId = setInterval(updateTimer, 1000);
        }

        function capturePhoto() {
            const fileName = new Date().getTime() + '.jpg';
            WebCamera.snap(function (data_uri) {
                // Save the photo to the disk
                var fs = require('fs');
                var path = require('path');
                var filePath = path.join(__dirname, fileName);
                var data = data_uri.replace(/^data:image\/\w+;base64,/, "");
                var buf = new Buffer(data, 'base64');
                fs.writeFile(filePath, buf, function (err) {
                    if (err) {
                        console.log(err);
                    } else {
                        console.log("The file was created!");
                    }
                });
            });

            return fileName;
        }

        async function  processImages(photoNames) {
            var jimp = require('jimp');
            const filter = await jimp.read('filter.png');
            for (var i = 0; i < photoNames.length; i++) {
                const image = await jimp.read(photoNames[i]);
                
                // Crop from center to 9:16
                const curretAspectRatio = image.bitmap.width / image.bitmap.height;
                const targetAspectRatio = 9 / 16;
                if (curretAspectRatio > targetAspectRatio) {
                    // If the image is too wide, crop the left and right edges
                    const newWidth = image.bitmap.height * targetAspectRatio;
                    const newHeight = image.bitmap.height;
                    const x = (image.bitmap.width - newWidth) / 2;
                    const y = 0;
                    image.crop(x, y, newWidth, newHeight);
                } else if (curretAspectRatio < targetAspectRatio) {
                    // If the image is too tall, crop the top and bottom edges
                    const newWidth = image.bitmap.width;
                    const newHeight = image.bitmap.width / targetAspectRatio;
                    const x = 0;
                    const y = (image.bitmap.height - newHeight) / 2;
                    image.crop(x, y, newWidth, newHeight);
                }

                // Resize the photos to 1080x1920
                image.resize(1080, 1920);

                // Set the filter.png image as a filter to the photos
                image.composite(filter, 0, 0, {
                    mode: jimp.BLEND_SCREEN,
                    opacityDest: 1,
                    opacitySource: 1
                });

                // Save the photo to the disk
                image.write(photoNames[i]);
            }
        }

        function cropPhotos(photoNames) {
            // Crop from center to 9:16
            var Jimp = require("jimp");
            photoNames.forEach(function (photoName) {
                Jimp.read(photoName, function (err, image) {
                    if (err) throw err;
                    const curretAspectRatio = image.bitmap.width / image.bitmap.height;
                    const targetAspectRatio = 9 / 16;
                    if (curretAspectRatio > targetAspectRatio) {
                        // If the image is too wide, crop the left and right edges
                        const newWidth = image.bitmap.height * targetAspectRatio;
                        const newHeight = image.bitmap.height;
                        const x = (image.bitmap.width - newWidth) / 2;
                        const y = 0;
                        image.crop(x, y, newWidth, newHeight);
                    } else if (curretAspectRatio < targetAspectRatio) {
                        // If the image is too tall, crop the top and bottom edges
                        const newWidth = image.bitmap.width;
                        const newHeight = image.bitmap.width / targetAspectRatio;
                        const x = 0;
                        const y = (image.bitmap.height - newHeight) / 2;
                        image.crop(x, y, newWidth, newHeight);
                    }
                    image.write(photoName);
                });
            });

        }

        function resizePhotos(photoNames) {
            // Resize the photos to 1080x1920
            var Jimp = require("jimp");
            photoNames.forEach(async function (photoName) {
                await Jimp.read(photoName, function (err, image) {
                    if (err) throw err;
                    image.resize(1080, 1920).write(photoName);
                });
            });
        }

        function addFilterToImages(photoNames) {
            // Set the filter.png image as a filter to the photos
            var Jimp = require("jimp");
            photoNames.forEach(function (photoName) {
                Jimp.read('filter.png', function (err, filter) {
                    if (err) throw err;
                    image.composite(filter, 0, 0).write("output.jpg");
                });
            });
        }

        function sendEmail(data, phtoNames) {
            // Send email with the photos
            var nodemailer = require('nodemailer');
            senderEmail = process.env.NG_EMAIL;
            senderPassword = process.env.NG_EMAIL_PASSWORD;
            var transporter = nodemailer.createTransport({
                host: 'smtp.office365.com', // Office 365 server
                port: 587, // secure SMTP
                secure: false, // false for TLS - as a boolean not string
                auth: {
                    user: senderEmail,
                    pass: senderPassword
                }
            });
            
            var fs = require('fs');

            // Read subject and body from file
            const subject = fs.readFileSync(__dirname + '\\emailSubject.txt', 'utf8');
            const body = fs.readFileSync(__dirname + '\\emailBody.html', 'utf8');

            var mailOptions = {
                from: senderEmail,
                to: data.email,
                subject: subject,
                text: body,
                attachments: phtoNames.map(function (photoName) {
                    return {
                        path: photoName
                    }
                })
            };

            transporter.sendMail(mailOptions)
                .then(function (info) {
                    console.log('Email sent: ' + info.response);
                    copyPhotosToNGFolder(phtoNames);
                })
                .catch(function (err) {
                    console.log(err)
                    copyPhotosToNGFolder(phtoNames);
                });

        }
        
        async function copyPhotosToNGFolder(photoNames) {
            var fs = require('fs');
            var path = require('path');
            
            // Get NG folder path from a system variable
            var ngFolder = process.env.BASE + '\\IO\\Source1';
            //var ngFolder = 'C:\\Users\\williamsm\\Documents\\personal_workspace\\novagenesis\\IO\\Source1';

            if (!fs.existsSync(ngFolder)) {
                fs.mkdirSync(ngFolder);
            }
            photoNames.forEach(function (photoName) {
                var filePath = path.join(__dirname, photoName);
                var newFilePath = path.join(ngFolder, photoName);
                fs.rename(filePath, newFilePath, function (err) {
                    if (err) throw err;
                    console.log('File moved!');
                });
            });
        }
        
        // Function to check form validity and enable/disable the "Começar" button
        function checkFormValidity() {
            const nameInput = document.getElementById('name');
            const emailInput = document.getElementById('email');
            const capturarButton = document.getElementById('capturarButton');

            
            if (nameInput.checkValidity() && emailInput.checkValidity() && nameInput.value && emailInput.value) {
                enableFormButton();
            } else {
                disableFormButton();
            }
        }

        // Add event listeners to form fields to check validity on input changes
        document.getElementById('name').addEventListener('input', checkFormValidity);
        document.getElementById('email').addEventListener('input', checkFormValidity);

        // Disabble form and last message
        document.getElementById('formBox').style.display = 'none';
        document.getElementById('lastMessage').style.display = 'none';

        const WebCamera = require("webcamjs");

        // Enumerate devices and select the first camera
        navigator.mediaDevices.enumerateDevices()
            .then(function(devices) {
            devices.forEach(function(device) {
                if (device.kind === 'videoinput') {
                console.log(device.label + " id = " + device.deviceId);
                }
            });
            })
            .catch(function(err) {
            console.log(err.name + ": " + err.message);
            });

        WebCamera.set({
            width: 1280, // 1280
            height: 720, // 720
            crop_width: 1280,
            crop_height: 720,
            flip_horiz: true,
            image_format: 'jpeg',
            jpeg_quality: 100/* ,
            constraints: {
                deviceId: {
                    exact: 'e4e359fe074fede1cbfa27c0fb9e337b4224fc393ecc6a92009506dde407019e'
                }
            } */
        });

        WebCamera.attach('#videoCamera');

        // Add filter to the camera preview
        const filterPreview = document.getElementById('filterPreview');
        filterPreview.style.backgroundImage = 'url("filter.png")';
        filterPreview.style.backgroundSize = 'cover';
        filterPreview.style.backgroundRepeat = 'no-repeat';
        filterPreview.style.backgroundPosition = 'center';

        // only for testing
        //show camera preview
        /* document.getElementById('cameraPreview').style.display = 'none';
        document.getElementById('videoCamera').style.display = 'none';
        //show filter preview
        document.getElementById('filterPreview').style.display = 'none';
        // hide all other elements
        document.getElementById('initialInfo').style.display = 'none';
        document.getElementById('formBox').style.display = 'flex';
        document.getElementById('lastMessage').style.display = 'none';
        document.getElementById('timer-container').style.display = 'none'; */

    </script>
</body>

</html>